%% MFI-1/298K data
load('MFI-1-298K.mat');

% Calculate vapor pressure for high pressure liquid water
p_sat_H2O=exp(1.50116)*1e3;  % T=298K
V_H2O=18.015e-6/0.991665;  % g/mL -> m^3/mol
water(:,1)=exp((water(:,1)-p_sat_H2O)*V_H2O/8.314/298)*p_sat_H2O;

%% MFI-1/323K data
load('MFI-1-323K.mat');

%% LTA-0/323K data
load('LTA-0-323K.mat');

% Calculate vapor pressure for high pressure liquid water
p_sat_H2O=18.165e3;  % T=323K
V_H2O=18.46e-6;  % m^3/mol
% water(:,1)=exp((water(:,1)-p_sat_H2O)*V_H2O/8.314/323)*p_sat_H2O;

%% FAU-2/323K data
load('FAU-2-323K.mat');

% Calculate vapor pressure for high pressure liquid water
p_sat_H2O=18.165e3;  % T=323K
V_H2O=18.46e-6;  % m^3/mol
% water(:,1)=exp((water(:,1)-p_sat_H2O)*V_H2O/8.314/323)*p_sat_H2O;

%% DDR-1/323K data
load('DDR-1-323K.mat');

% Calculate vapor pressure for high pressure liquid water
p_sat_H2O=18.165e3;  % T=323K
V_H2O=18.46e-6;  % m^3/mol
% water(:,1)=exp((water(:,1)-p_sat_H2O)*V_H2O/8.314/323)*p_sat_H2O;

%% Preparation
set(0,'DefaultTextInterpreter','latex');
options=optimset('Display','iter');

S={[water(:,1),water(:,2)],[ethanol(:,1),ethanol(:,2)]};
M={[ethanol_water(:,1),ethanol_water(:,3)],[ethanol_water(:,2),ethanol_water(:,4)]};
Q=[ethanol_water(:,3),ethanol_water(:,4)];
z=Q./sum(Q,2);
N = length(M);
ndata = size(M{1}, 1);

% Fitting single-component isotherms
% [isotherm, minlnP, maxlnP, ads_pot, inv_ads_pot] = fit_Langmuir_Sips(S(1));
[isotherm, minlnP, maxlnP, ads_pot, inv_ads_pot] = fit_piecewise_polynomial(S(1));
[isotherm(2), minlnP(2), maxlnP(2), ads_pot(2), inv_ads_pot(2)] = fit_piecewise_polynomial(S(2));

%% Plotting single-component isotherms
lnP_plot = linspace(min(log(S{1}(:,1)))*0.9, max(log(S{1}(:,1)))*1.1, 100);
Q_plot = isotherm{1}(lnP_plot);
semilogx(S{1}(:,1), S{1}(:,2), 'o', 'DisplayName', 'H2O');
hold on; semilogx(exp(lnP_plot), Q_plot, '-', 'DisplayName', 'H2O fitted');

figure;
lnP_plot = linspace(min(log(S{2}(:,1)))*0.9, max(log(S{2}(:,1)))*1.1, 100);
Q_plot = isotherm{2}(lnP_plot);
semilogx(S{2}(:,1), S{2}(:,2), 'o', 'DisplayName', 'EtOH')
hold on; semilogx(exp(lnP_plot), Q_plot, '-', 'DisplayName', 'EtOH fitted');

%% Mode 1 or 2 or 102
% x0 = [9.54659916507525,4.45822504852441,2.15015220983416,1.03285147519273;10.7092938249809,8.49842481784590,2.46727400686816,1.01342556124652;10.8598606883720,8.94395738832644,2.92892137665078,0.862798610037701;10.8013182779368,8.77124933794977,2.81583193277256,0.869093701483178;10.8660845799886,8.96227898971391,1.00984319158690,0.910873219810828;10.7824636368829,8.71549854469242,2.57892239958312,0.949060084134431;10.9331442608880,9.15925089128384,2.88408028020013,0.710472042871600;10.8518734104143,8.92044227889966,2.80653371721469,0.876490902667201;10.6354780724902,8.27801822024613,2.13091117211549,1.06051664853207;9.46847853923580,3.96055003075170,2.02507717540426,1.07826261415205;10.5764030026928,8.09877533994039,2.13590409238473,0.991620827971923;9.41428645344238,3.51197080883258,1.74561738840598,1.16350873586547;9.83768171256791,5.69098927267615,2.24765635120982,0.910258115420987];  % MFI-1, 298K
% x0 = [9.19074037382604,5.09736861287326,3.03271843050511,2.27915890872639;9.22930125758334,6.06111397875104,4.36054648137393,1.57614414145470;9.28511251961734,7.49244696500350,4.29082822781169,1.18543463456380;9.75903510736948,10.1366045075341,2.57077962210034,0.296151159422557;9.58400894142692,9.37039980212221,3.37120938170920,1.36585454540269;9.81803704095643,10.3845083678447,2.68370034335134,0.713789089929751;9.80180682142322,10.3169912086654,2.74225698564950,0.796137246747622;9.84022393484934,10.4765016692427,2.44234340204493,0.797246040196091;9.82150072042286,10.3989549906469,2.23261466089940,0.918720382520571;9.79039123665228,10.2690571146685,2.17338756602035,1.04612143815037;9.78967192063356,10.2660260838746,1.00092129902735,1.00201175753042];  % FAU-2, 323K
x0 = [];
[Q_predicted, x, err, lnP0, psi, Q_IAST, x_IAST, err_IAST, lnP0_IAST, psi_IAST] = RAST_solve(M, S, 'mode', 1, 'tol', 1e-6, 'isotherm', isotherm, 'minlnP', minlnP, 'ads_pot', ads_pot, 'inv_ads_pot', inv_ads_pot, 'EoS', @Margules, 'x0', x0);
gamma = x(:, N+1:end);
coeff = fit_activity_model(@Margules_ads, 3, [z(:,1), psi(:, 1)], gamma)
% C_ub = 0 is important because C can be arbitrarily varied without
% affecting the results
coeff2 = fit_activity_model(@Margules, 3, [z(:,1), psi(:, 1)], gamma, 'C_ub', 0)

%% Plot activity coefficients
z_plot = linspace(0, 1, 100)';
gamma_plot = Margules(coeff2, z_plot);
plot(z(:,2),gamma(:,2),'ro',z(:,2),gamma(:,1),'bo',1-z_plot,gamma_plot(:,2),'m-',1-z_plot,gamma_plot(:,1),'c-');
xlabel('$x_{\textrm{EtOH}}$'); ylabel('$\gamma$');
legend('sim\_EtOH','sim\_H2O','Margules\_EtOH','Margules\_H2O','Location','NorthEastOutside');

figure;
plot(z(:,2),log(gamma(:,2)),'ro',z(:,2),log(gamma(:,1)),'bo',1-z_plot,log(gamma_plot(:,2)),'m-',1-z_plot,log(gamma_plot(:,1)),'c-');
xlabel('$x_{\textrm{EtOH}}$'); ylabel('$\ln\gamma$');
legend('sim\_EtOH','sim\_H2O','Margules\_EtOH','Margules\_H2O','Location','NorthEastOutside');

hold on
gamma_plot_0_5 = Margules_ads(coeff, [z_plot, 0.5*ones(size(z_plot))]);
gamma_plot_5 = Margules_ads(coeff, [z_plot, 5*ones(size(z_plot))]);
gamma_plot_50 = Margules_ads(coeff, [z_plot, 50*ones(size(z_plot))]);
gamma_plot_100 = Margules_ads(coeff, [z_plot, 100*ones(size(z_plot))]);
gamma_plot_130 = Margules_ads(coeff, [z_plot, 130*ones(size(z_plot))]);
plot(1-z_plot,log(gamma_plot_0_5(:,2)),'m--','DisplayName','0.5 EtOH');
plot(1-z_plot,log(gamma_plot_0_5(:,1)),'c--','DisplayName','0.5 H2O');
plot(1-z_plot,log(gamma_plot_5(:,2)),'m:','DisplayName','5 EtOH');
plot(1-z_plot,log(gamma_plot_5(:,1)),'c:','DisplayName','5 H2O');
plot(1-z_plot,log(gamma_plot_50(:,2)),'m^','DisplayName','50 EtOH');
plot(1-z_plot,log(gamma_plot_50(:,1)),'c^','DisplayName','50 H2O');
plot(1-z_plot,log(gamma_plot_100(:,2)),'m+','DisplayName','100 EtOH');
plot(1-z_plot,log(gamma_plot_100(:,1)),'c+','DisplayName','100 H2O');
plot(1-z_plot,log(gamma_plot_130(:,2)),'ms','DisplayName','130 EtOH');
plot(1-z_plot,log(gamma_plot_130(:,1)),'cs','DisplayName','130 H2O');

%% Mode 3
x0 = [];
[Q_predicted, x, err, lnP0, psi, Q_IAST, x_IAST, err_IAST, lnP0_IAST, psi_IAST] = RAST_solve(M, S, 'mode', 3, 'C_ub', +Inf, 'tol', 1e-6, 'isotherm', isotherm, 'minlnP', minlnP, 'ads_pot', ads_pot, 'inv_ads_pot', inv_ads_pot, 'EoS', @Margules_ads, 'x0', x0, 'N_EoS_param', 3, 'EoS_deriv', @Margules_ads_deriv);
coeff=x(ndata*(2*N-1)+1:end);

%% Mode 4
% x0 = [9.56932133693453,4.58066201273206,10.7082849511984,8.49498775552621,10.8136012238689,8.80710044581727,10.7775612220731,8.70082664812700,10.8398067691370,8.88440817552311,10.7573893791015,8.64146621420108,10.8190808116371,8.82396736941342,10.8138929966375,8.80816989694733,10.6028098033075,8.17959060389455,9.47753850237952,4.01646853415337,10.6078313303063,8.19611051552091,9.42404124399680,3.57813075474896,9.85707396913871,5.75919521857211,3.89521912479900,1.15354151246764,0.0352689984934897]; % MFI-1, 298K
% x0 = [10.6230063445220	5.62307974603009	10.7330020095963	6.07194189255608	10.8807402385609	6.69797038595672	11.0365038900875	7.27463891118763	11.2240806087879	7.90318705278506	11.3826155343223	8.41458696039468	11.5713072731428	9.00682132221415	11.7571929087347	9.56704580253821	11.9744886290707	10.2066192628490	12.1536842809974	10.7363134430543	12.3537925144421	11.3145605435504	12.5598422574625	11.8984382869287	12.7884861345292	12.5310067126958	12.9801613036560	13.0570186859880	9.85700193430392	4.66930391283362	10.5185200990323	5.33535557776264	10.6818963808551	5.85937083545221	10.8225132374114	6.45177739219620	10.9683660869715	7.03243100985095	11.1499710198389	7.65850882936091	11.3058028130887	8.16870603831180	11.4922209172077	8.76052477320105	11.6764919010652	9.32653285816856	11.8951194814231	9.97229823181792	12.0731593556600	10.4969889963727	12.2783731938783	11.0894786290421	12.4893047467918	11.6885256708950	12.7308744323736	12.3600539988589	12.9297771499194	12.9363336614174	9.18579404462085	4.41708679474946	10.3647537713219	5.00528809719404	10.5789302943823	5.48342490823993	10.7457605441070	6.12491865041861	10.8861615086706	6.71977273558535	11.0487928469646	7.31703157958779	11.2029147938056	7.83366829696756	11.3889453931794	8.43487620983864	11.5748568865937	9.01785092756674	11.7877799600145	9.65529100207212	11.9724872633752	10.2060144931029	12.1815165756911	10.8314155428993	12.4031356357729	11.4177152494193	12.6678084883777	12.1355507398085	12.9269445045093	12.7442093047958	9.45029966371921	4.50959326717793	10.3559532194280	4.99268388483763	10.6099553479216	5.57713076375055	10.7582528658584	6.17714648007229	10.9146314165839	6.83154110124259	11.0519173896022	7.32772203038099	11.2336853832323	7.93449992325135	11.4187699978995	8.52920124012011	11.6296199369574	9.18261776926023	11.8097466586085	9.70773845203695	12.0343350995339	10.3722803991709	12.2737867665873	11.0559591357105	12.5926918988808	11.8779950919584	12.9232366880860	12.7255234848901	9.56128675402882	4.55130716995609	10.4172277069937	5.10044724826978	10.6505673456125	5.72932582509347	10.7745389987112	6.24588641216044	10.9251689797184	6.87191779158150	11.0950725632916	7.47424166867928	11.3079464975142	8.17810539379382	11.4968492904588	8.78312140764199	11.7482228345410	9.54703705592230	12.0759623436077	10.4654804604364	12.5697928277449	11.8151095525299	13.0699523718072	13.1494026467160	1.08788253355405	0.963935433250815	158.460631487017];  % MFI-1, 323K, 1.855786e-01, 0.0927674635408787
% x0 = [10.6230243222160	5.62314447599076	10.7330094077426	6.07197669707313	10.8807434624503	6.69795639663977	11.0364999964567	7.27462738592186	11.2240774877291	7.90317856392562	11.3826128180663	8.41458018503460	11.5713049172652	9.00681596443679	11.7571905235580	9.56704105631007	11.9744864287035	10.2066158809578	12.1536801527530	10.7363072827608	12.3537877347328	11.3145568682659	12.5598339417457	11.8984326803241	12.7884696002305	12.5309974430738	12.9801272183449	13.0569976299116	9.85783442492148	4.66966822475366	10.5186306726588	5.33562743544201	10.6819337820035	5.85952734016272	10.8225085311068	6.45177585521157	10.9683607122392	7.03241802939983	11.1499676276347	7.65850007027914	11.3058005535277	8.16869872376299	11.4922180858227	8.76051869420822	11.6764887874288	9.32652695858057	11.8951136897313	9.97229038891806	12.0731482172167	10.4969783620772	12.2783553174425	11.0894644100924	12.4892631206811	11.6884897428144	12.7307840849992	12.3599666699646	12.9296494009080	12.9361483263645	9.18622119690047	4.41722026108216	10.3652783563548	5.00607074159661	10.5792542320288	5.48426570349806	10.7458259765111	6.12517467397427	10.8861607684752	6.71976539577095	11.0487886828277	7.31701996243377	11.2029118341519	7.83365909473403	11.3889411041060	8.43486558587932	11.5748500379178	9.01783748954438	11.7877676629791	9.65527226484354	11.9724543421016	10.2059629234039	12.1814514167172	10.8313132685196	12.4030466298871	11.4176081765963	12.6676848690519	12.1353238731851	12.9268473790037	12.7438859657460	9.45352860119547	4.51078240768636	10.3573073275759	4.99454825682816	10.6103934965292	5.57860728844424	10.7583477511472	6.17753953239262	10.9146303129645	6.83153052589621	11.0519128838876	7.32770880029353	11.2336794528407	7.93448300903769	11.4187582977195	8.52917412938654	11.6295951651701	9.18257264099155	11.8097039129811	9.70767091555791	12.0342465426286	10.3721097851561	12.2736828750945	11.0556587166497	12.5926533289583	11.8775804692361	12.9232789582754	12.7253146892917	9.57466023365172	4.55634308623633	10.4212985128660	5.10902869797673	10.6520752113960	5.73542219865239	10.7748023518755	6.24700687335505	10.9251662361236	6.87190065700932	11.0950480348846	7.47417205576096	11.3078879278970	8.17793539142712	11.4967533275185	8.78282036824560	11.7481371894635	9.54665641323053	12.0759697262779	10.4653300403722	12.5698668088034	11.8153410455695	13.0700120164213	13.1495977658725	1.08666539363822	0.966089416913972	6.11688346859249];  % MFI-1, 323K, 1.868520e-01, 0.117279148980754
% x0 = [10.6230166879181	5.62311551233868	10.7330428962257	6.07211240824494	10.8807507236389	6.69800990986544	11.0365072214991	7.27465314014624	11.2240717299441	7.90316196162756	11.3826055310379	8.41456183848303	11.5712970688002	9.00679981503555	11.7571801033995	9.56702192499182	11.9744755497003	10.2065985634056	12.1536558399578	10.7362766094927	12.3537633039697	11.3145364398685	12.5597902158976	11.8984013613899	12.7883821347026	12.5309459225358	12.9799412952911	13.0568891006383	9.85706075693241	4.66933008265309	10.5185628991811	5.33546129889663	10.6819622474802	5.85964650654236	10.8226022545893	6.45218167473365	10.9684465815469	7.03272571870299	11.1500083652695	7.65863928403154	11.3058081090252	8.16872804833026	11.4922140109861	8.76051392907115	11.6764775767618	9.32650749833681	11.8950863084234	9.97225277983097	12.0730995553518	10.4969226417785	12.2782669800243	11.0893878306799	12.4890345818836	11.6883052710093	12.7302548641749	12.3595249579195	12.9287905260213	12.9352010915509	9.18447850177456	4.41666045450639	10.3648781087782	5.00547318118651	10.5791304970064	5.48394442729201	10.7461202833597	6.12639966951549	10.8864201600510	6.72080204620223	11.0488954376690	7.31737892634391	11.2029578161771	7.83380376688627	11.3889491680909	8.43490356647602	11.5748391874123	9.01783677324411	11.7877076584173	9.65518481638522	11.9722786422545	10.2057141962761	12.1810845450118	10.8308054445669	12.4025264556450	11.4170562447816	12.6668152791206	12.1341288192325	12.9259295052390	12.7421198017315	9.45037344580591	4.50961705440253	10.3563276844436	4.99319510121116	10.6103002475535	5.57829026728398	10.7590064721182	6.18029639835276	10.9152340981655	6.83383583770768	11.0523413413491	7.32913401458075	11.2338388370174	7.93496759548933	11.4188017679481	8.52932403314184	11.6295404072061	9.18252560714155	11.8094996236888	9.70736970746015	12.0337227756852	10.3712390175104	12.2729118699612	11.0540379756811	12.5919615088126	11.8749926349649	12.9228799261923	12.7225867683162	9.56449357199787	4.55244412288570	10.4186663895849	5.10342802670131	10.6524722522585	5.73696696101735	10.7777566060432	6.25938463758874	10.9289116115034	6.88578424055702	11.0968054487081	7.47966067672822	11.3086624518616	8.18023478515088	11.4967874879731	8.78290358700340	11.7476458553759	9.54489021462099	12.0754507793136	10.4629844034498	12.5696894674141	11.8142273897980	13.0699925481873	13.1491526270406	1.08632255468108	0.977587974221860	0.999864262561022];  % MFI-1, 323K, 1.924528e-01, 0.289420249211078
% x0 = [10.6230045989620	5.62307152872569	10.7330092466754	6.07197279628325	10.8807398150373	6.69796564768418	11.0365118560815	7.27466874509084	11.2240832128835	7.90319748607568	11.3826307436730	8.41463562527037	11.5713511317396	9.00694832693104	11.7572689945294	9.56723986691693	11.9745178935449	10.2066573366477	12.1537670072816	10.7366663146495	12.3539192019661	11.3148372987182	12.5598784622178	11.8986928016735	12.7880509832232	12.5310723743354	12.9779095963217	13.0562754553608	9.85692075331869	4.66926851089490	10.5185193966989	5.33535659466009	10.6819078131208	5.85941940335684	10.8225380346548	6.45190168767407	10.9684266801889	7.03264878384104	11.1500976593687	7.65890919501966	11.3059182721183	8.16903063258327	11.4923890342062	8.76091553408681	11.6767671612513	9.32710236333969	11.8956157609312	9.97300852672147	12.0739973516011	10.4981304162536	12.2795183044744	11.0908057791148	12.4903801987190	11.6899616799994	12.7287280920090	12.3594892179429	12.9190753236076	12.9289698118695	9.18418210057316	4.41656386357681	10.3647504660810	5.00528172566694	10.5789624727928	5.48350833717565	10.7458567544061	6.12530241774400	10.8862795529202	6.72023579218746	11.0489377945738	7.31750732213471	11.2031427617768	7.83430762924662	11.3895134854367	8.43619752752372	11.5759792113534	9.02015554591543	11.7892483762226	9.65710557689194	11.9752671362420	10.2093679827828	12.1855605746012	10.8367040212105	12.4079015279638	11.4229942677742	12.6677693783753	12.1364354364241	12.9189607245250	12.7353654878521	9.44975936107599	4.50938993730575	10.3559992146499	4.99274336804571	10.6100208403893	5.57734139690398	10.7584723464086	6.17805218326399	10.9150033755199	6.83292550806145	11.0526159282834	7.32992460624718	11.2348162181198	7.93736929319286	11.4210827414157	8.53399487797407	11.6344624990159	9.19112559426546	11.8164569234939	9.71634836880050	12.0457925386105	10.3865576399967	12.2871617014419	11.0755183256717	12.5983951053802	11.8869085820350	12.9184718568365	12.6983176376779	9.56236891132179	4.55162974858243	10.4175720450012	5.10112648878482	10.6510338475432	5.73114206461297	10.7757191455201	6.25071718694181	10.9287113099591	6.88438925079186	11.1018067622675	7.49325926072633	11.3247041200902	8.21952709848275	11.5253731778258	8.85069218445420	11.7883157258181	9.64832339544674	12.1085594388187	10.5688421053655	12.5749734866923	11.8346504923170	13.0587192936899	13.0912239558426	1.47590302146526	1.37982397428700	0.0999154388297144];  % MFI-1, 323K, 2.580944e-01, 0.568398753245121
% x0 = [9.19729790932091	5.23431975812199	9.23403007981952	6.17599371090517	9.28745354794246	7.51930114184869	9.67700174179077	9.75343881277270	9.73103818319680	10.0089422434589	9.77815273418184	10.2370918952673	9.79352221859579	10.2955428593557	9.81428792733339	10.3992010526970	9.83653005950897	10.4735274680741	9.83231124304079	10.4358726784654	9.79232288898369	10.2769360919148	5.84080405314012	-1.18588085285962	0.00999968625557277];  % FAU-2, 323K
% x0=[9.83936297560183,4.97292910849719,9.84866598014940,6.09052993415287,9.90264670393793,7.40188150999622,10.1082476807207,8.48418100739620,10.2532490607674,9.24794117177083,10.3212287711267,9.65680802703133,10.3326892389181,9.72836846051617,10.3643190469011,9.93127734182888,10.3923370573292,10.1181347206316,10.3931617016872,10.1254748503674,10.4212127900103,10.3197024200992,1.06936343759260,2.96878064702337];  % LTA-0, 323K
% x0 = [10.4423986203318	6.10586973352210	10.5634036121283	6.71364023139198	10.6677755713165	7.27051454581147	10.7789353960961	7.93800217070999	10.8592989317376	8.42842616357128	10.9680383094351	9.02329892249718	11.0850185144163	9.60739129547783	11.2226343183831	10.2312564078970	11.3528113582684	10.7893889341439	11.4988830064117	11.3879359550120	11.6612716756224	12.0286172787092	11.8544289698297	12.7628728685924	12.0212679904379	13.3609492427007	10.2412805712769	5.36395414437996	10.3903497545047	5.87178908366500	10.5129196892251	6.45663703852472	10.6237462598369	7.02258216794640	10.7381397581980	7.68666915664459	10.8204237057698	8.19452288602896	10.9218045876171	8.77912752368804	11.0420663175106	9.39593111556091	11.1846819095672	10.0617748769311	11.3080979721773	10.5852644091043	11.4842973024944	11.3172683905871	11.6824199386065	12.0788323071860	11.9554670923289	13.1454199155782	12.2848756010146	14.0145094993634	9.26656474804608	4.46554415295375	10.1082731593508	5.03881457609306	10.2962085310412	5.52930068688974	10.4407757611083	6.12060951235289	10.5621396931431	6.70715851914167	10.6742480729521	7.30780021345431	10.7762957684909	7.92132822761002	10.8661410342508	8.46563566030531	10.9869249573215	9.11519079622745	11.1268973655294	9.80132880733551	11.2759442497548	10.4401641649239	11.4823991381929	11.3006270772964	11.7395751807969	12.3239728181122	12.1526195344416	13.6740263341931	12.6155589664773	15.0845620700323	9.44716146104839	4.55562462480815	10.1023543214995	5.02865015198165	10.3215509815060	5.60984796408659	10.4615636217656	6.20778345171769	10.5854367484012	6.82372485517764	10.6858917174964	7.37249635724306	10.7931470649489	8.02497246867795	10.8921913334105	8.61393963680487	11.0540049984297	9.44816671657581	11.2302380770041	10.2590251796889	11.4764012147134	11.2803850449408	11.8276379281842	12.6039183186934	12.3819260036843	14.4298081227475	12.9207693948732	16.0117287422980	9.48461451862356	4.57360494436534	10.1547013035116	5.13426134082988	10.3658410228615	5.77139573989210	10.4736631088570	6.26602018243808	10.6050019104886	6.92503799955404	10.7303899344659	7.63560261970593	10.8867216429010	8.57228349543002	11.1102324180836	9.72968109621001	11.4541285695634	11.1877866824776	11.9587485820177	13.0456486959891	12.5984565637908	15.1354218084907	13.1240447278935	16.7327483395978	-0.0133854544000638	-0.157932895779991	0.00466486395933180];  % DDR-1, 323K
x0 = [];
[Q_predicted, x, err, lnP0, psi, Q_IAST, x_IAST, err_IAST, lnP0_IAST, psi_IAST] = RAST_solve(M, S, 'mode', 4, 'C_ub', +Inf, 'tol', 1e-6, 'isotherm', isotherm, 'minlnP', minlnP, 'ads_pot', ads_pot, 'inv_ads_pot', inv_ads_pot, 'EoS', @Margules_ads, 'x0', x0, 'N_EoS_param', 3, 'EoS_deriv', @Margules_ads_deriv);
coeff=x(ndata*N+1:end);

%% Mode 4 with no \Psi-dependence
% Set C_ub = 0, EoS = @Margules, N_EoS_param = 3, EoS_deriv = @(x,y)0
% C_ub = 0 is important because C can be arbitrarily varied without
% affecting the results
% x= [10.6230004972963	5.62305656087981	10.7329965908267	6.07192021570663	10.8807287955657	6.69792126318381	11.0364897637121	7.27459252798149	11.2240670678038	7.90314685258659	11.3826025460599	8.41455252556048	11.5712950324092	9.00679302938774	11.7571805450201	9.56702270608880	11.9744763666808	10.2066000909880	12.1536722310552	10.7362974158595	12.3537796111136	11.3145484054518	12.5598302882532	11.8984293560372	12.7884717551342	12.5310036626951	12.9801483156360	13.0570158273739	9.85687049006538	4.66924696799915	10.5185096216537	5.33533256866876	10.6818925408452	5.85935590211937	10.8224968939257	6.45172386802972	10.9683518052088	7.03238110006997	11.1499568542740	7.65846516025724	11.3057895042328	8.16866860226218	11.4922081487733	8.76049299926858	11.6764813891387	9.32650640124208	11.8951055503884	9.97227771883936	12.0731465190458	10.4969714798922	12.2783601672870	11.0894648852874	12.4892937718291	11.6885120277921	12.7308566491059	12.3600449647508	12.9297583308794	12.9363232864165	9.18405794077362	4.41652558974664	10.3647202740653	5.00523771976482	10.5789225930560	5.48340621204966	10.7457546866051	6.12487982625657	10.8861497058613	6.71972285010506	11.0487784472057	7.31698479086521	11.2029008478671	7.83362627787723	11.3889319833117	8.43484049293149	11.5748439359478	9.01782124414929	11.7877690810013	9.65526525782002	11.9724730104673	10.2059913070345	12.1815017609138	10.8313935801039	12.4031198322045	11.4176970009547	12.6677913947293	12.1355315508555	12.9269296118323	12.7441900730235	9.44945390644045	4.50928508097414	10.3559188551221	4.99263706953129	10.6099510853959	5.57710865686740	10.7582444551019	6.17710685033016	10.9146179738889	6.83149157741585	11.0519029885538	7.32767540784981	11.2336710525477	7.93445755721501	11.4187558403529	8.52916483220601	11.6296062353746	9.18258613721753	11.8097331202427	9.70770917391627	12.0343164735033	10.3722514947885	12.2737704372901	11.0559270490720	12.5926811001142	11.8779624148184	12.9232309366590	12.7255033196241	9.55988075387882	4.55077270007161	10.4172001926370	5.10039562040546	10.6505595569035	5.72929634512381	10.7745290701310	6.24585024405004	10.9251545157655	6.87186568556616	11.0950550173503	7.47418602691387	11.3079281687771	8.17805183951828	11.4968293178466	8.78306654841244	11.7482049329697	9.54698314384276	12.0759518828653	10.4654373460335	12.5697930221954	11.8151227025588	13.0699488965611	13.1494129957162	1.08783376537203	0.964066328086121	0];  % MFI-1, 323K, 0.185509681630810, 1.27780812384578
x0 = [];
[Q_predicted, x, err, lnP0, psi, Q_IAST, x_IAST, err_IAST, lnP0_IAST, psi_IAST] = RAST_solve(M, S, 'mode', 4, 'C_ub', 0, 'tol', 1e-6, 'isotherm', isotherm, 'minlnP', minlnP, 'ads_pot', ads_pot, 'inv_ads_pot', inv_ads_pot, 'EoS', @Margules, 'x0', x0, 'N_EoS_param', 3, 'EoS_deriv', @(x,y)0);
coeff=x(ndata*N+1:end);

%% Mode 5
% x0 = [34.1512916754137,0.797662310980325,0.00999386469064226];  % MFI-1, 298K
% x0 = [22.5419330501665,-50.6850374059142,0.00999789298249896];  % FAU-2, 323K
x0 = [];
[Q_predicted, x, err, lnP0, psi, Q_IAST, x_IAST, err_IAST, lnP0_IAST, psi_IAST] = RAST_solve(M, S, 'mode', 5, 'C_ub', +Inf, 'g_lb', -1e2, 'g_ub', 1e2, 'tol', 1e-6, 'isotherm', isotherm, 'minlnP', minlnP, 'ads_pot', ads_pot, 'inv_ads_pot', inv_ads_pot, 'EoS', @Margules_ads, 'x0', x0, 'N_EoS_param', 3, 'EoS_deriv', @Margules_ads_deriv);
coeff = x;

%% Mode 6 or 7
% x0 = [0.033711457199233   1.413024266956713   4.662419644556619];  % MFI-1, 323K, 3.558561e-02
x0 = [4.14217556880240	3.92972231407470	22.1284380530382];  % FAU-2, 323K, 4.013472
% x0 = [-0.002058250651699  -0.001745770844332   0.990032864650932];  % DDR-1, 323K, 1.833686e+01, start from []
% x0 = [-1.575693142926877  -1.583756934985301   0.006652244308074];  % DDR-1, 323K, 2.526532e+01, start from Krishna
% x0 = [25.750814178778423 -78.638001831074405   0.000017211231730];  % DDR-1, 323K, 1.812443e+01, start from mode 4
% x0 = [0.413166407641744  -0.102831979530554   0.000187890886726];  % DDR-1, 323K, 1.812443e+01, start from mode 7
% x0 = [0.427567779575525   0.592843937345364   2.461603881389634];  % DDR-1, 323K, 1.503283e+01, start from all 0s, mode 7
% x0 = [];
[gamma, x, err, lnP0, psi, Q_IAST, x_IAST, err_IAST, lnP0_IAST, psi_IAST] = RAST_solve(M, S, 'mode', 6, 'C_ub', +Inf, 'g_lb', -1e2, 'g_ub', 1e2, 'tol', 1e-6, 'isotherm', isotherm, 'minlnP', minlnP, 'ads_pot', ads_pot, 'inv_ads_pot', inv_ads_pot, 'EoS', @Margules_ads, 'x0', x0, 'N_EoS_param', 3, 'EoS_deriv', @Margules_ads_deriv);
coeff = x;

%% RAST fitting with fitted EoS
x0 = [z(:,1:end-1), lnP0];
[err, Q_predicted, x, err_IAST, lnP0_IAST, psi_IAST] = RAST_func_IAST_solve(coeff, isotherm, M, @Margules_ads, 'mode', 1, 'x_lb', [0], 'x_ub', [1], 'tol', 1e-6, 'minlnP', minlnP, 'maxlnP', maxlnP, 'ads_pot', ads_pot, 'inv_ads_pot', inv_ads_pot, 'EoS_deriv', @Margules_ads_deriv, 'x0', x0, 'options', options);

%% Plotting isotherms
semilogx(M{2}(:,1),M{2}(:,2),'rs',M{2}(:,1),M{1}(:,2),'bo',M{2}(:,1),Q_predicted(:,2),'md',M{2}(:,1),Q_predicted(:,1),'c^');
xlabel('$p$ [Pa]'); ylabel('$N$ [molec/uc]');
legend('sim\_EtOH','sim\_H2O','RAST\_EtOH','RAST\_H2O','Location','NorthEastOutside');

%% Activity coefficients
gamma1 = Margules_ads(coeff, [x(:,1), psi_IAST(:,1)])
gamma2 = Margules_ads(coeff, [x(:,1), psi_IAST(:,2)])
gamma1 - gamma2
q_ex1 = Margules_ads_deriv(coeff, [x(:, 1), psi_IAST(:,1)])
q_ex2 = Margules_ads_deriv(coeff, [x(:, 1), psi_IAST(:,2)])
q_ex1 - q_ex2
Q_predicted1 = 1./(1./Q_predicted - q_ex1)
Q_predicted2 = 1./(1./Q_predicted - q_ex2)
Q_predicted - Q_predicted1
Q_predicted - Q_predicted2